## 1. 프로젝트 개요

DB\_backup 프로젝트는 **데이터 무결성 보장**과 **장애 대비**를 목적으로,

* **애플리케이션/사용자 디렉토리**
* **MySQL 데이터베이스**

두 가지 대상을 동시에 백업하도록 설계되었습니다.

백업은 수동 실행도 가능하지만, 운영 환경에서는 자동화가 핵심입니다. 따라서 `crontab`을 활용하여 **매일 정오**에 자동 실행되도록 구성합니다.

---

## 2. 백업 대상 설명

### 📂 디렉토리

* 경로: `/home/ubuntu/01.awk`
* 용도: 서비스 실행에 필요한 스크립트, 설정 파일, 로그 등

> **파일 시스템 백업의 필요성**
> 데이터베이스만 덤프한다고 해서 운영 환경이 그대로 복원되는 것은 아닙니다.
> 애플리케이션 코드, 설정 파일까지 같이 보관해야 “서비스 전체”를 복원할 수 있습니다.

---

### 🗄 데이터베이스

* 이름: `sqld`
* 테이블: `DEPT`, `EMP`
* 특징: 조직 구조와 인사 정보를 포함한 전형적인 ERP 예제 스키마

```sql
CREATE TABLE DEPT (
  DEPTNO DECIMAL(10),
  DNAME  VARCHAR(14),
  LOC    VARCHAR(13)
);

CREATE TABLE EMP (
  EMPNO    DECIMAL(4) NOT NULL,
  ENAME    VARCHAR(10),
  JOB      VARCHAR(9),
  MGR      DECIMAL(4),
  HIREDATE DATE,
  SAL      DECIMAL(7,2),
  COMM     DECIMAL(7,2),
  DEPTNO   DECIMAL(2)
);
```

> **DB 백업의 필요성**
> MySQL은 운영체제 오류나 디스크 장애 발생 시 데이터를 잃을 수 있습니다.
> `mysqldump`를 이용하면 구조와 데이터가 SQL 형태로 저장되어, 다른 서버에서도 동일한 DB를 쉽게 복원할 수 있습니다.

---

## 3. 백업 방식과 원리

### 1단계: 디렉토리 압축

* `tar -czf`를 이용하여 지정한 디렉토리를 `.tar.gz`로 압축
* 백업 시점의 파일 상태가 그대로 보관

### 2단계: MySQL 덤프

* `mysqldump`로 지정한 DB를 `.sql` 파일로 추출
* DB 구조 + 데이터 INSERT 문까지 기록됨

### 3단계: SQL 압축 및 정리

* `.sql` 파일을 `.tar.gz`로 압축
* 원본 `.sql` 삭제 → 저장 공간 절약

### 4단계: 로그 출력

* 각 단계 성공 여부를 사용자에게 알림

---

## 4. 자동화 (Crontab)

### 등록 방법

1. Crontab 편집

   ```bash
   crontab -e
   ```
2. 매일 정오 실행

   ```
   0 12 * * * /home/ubuntu/backup.sh >> /home/ubuntu/backup.log 2>&1
   ```

* `0 12 * * *` → 매일 12:00 실행
* `>> ... 2>&1` → 표준 출력과 에러 로그를 파일에 저장

### 장점

* 사람이 직접 명령어를 실행할 필요 없음
* 항상 같은 시점(정오)에 백업이 쌓여 관리 편리
* 로그 파일을 통해 실패 여부 확인 가능

---

## 5. 백업 파일 관리

### 저장 경로

```
/home/ubuntu/backups/
 ├── dir_backup_20250908_120000.tar.gz
 ├── mysql_backup_20250908_120000.tar.gz
 ├── dir_backup_20250909_120000.tar.gz
 └── mysql_backup_20250909_120000.tar.gz
```

### 보관 정책

* 무한정 보관 시 디스크 공간 부족 위험
* 일반적으로 **7일\~30일 단위 보관 정책** 권장

예시: 7일 지난 백업 삭제

```bash
find /home/ubuntu/backups -type f -mtime +7 -exec rm {} \;
```

---

## 6. 복원 방법

### 디렉토리 복원

```bash
tar -xzf dir_backup_날짜.tar.gz -C /
```

→ 지정된 시점의 파일을 그대로 복구

### DB 복원

```bash
gunzip < mysql_backup_날짜.tar.gz | mysql -u root -p 데이터베이스이름
```

→ DB 구조와 데이터를 그대로 복원

---

## 7. 운영 시 주의사항

1. **MySQL 계정 권한**

   * `mysqldump` 실행 권한 필요
   * 권한이 부족하면 덤프에 실패

2. **보안**

   * 백업 파일에는 **민감 데이터** 포함
   * 접근 권한 제한 필요 → `chmod 600 *.tar.gz`

3. **스토리지 관리**

   * 백업 디스크와 운영 디스크를 분리하는 것이 이상적
   * 가능하다면 원격지(예: S3, NFS, 별도 서버)에 2차 백업 권장

---

## 8. 확장 아이디어

* **암호화** : GPG로 tar.gz 파일 암호화
* **알림 연동** : Slack, 이메일로 백업 성공/실패 보고
* **멀티 DB 지원** : 여러 DB를 배열로 지정해 순차 덤프
* **Docker/Kubernetes 환경 지원** : 컨테이너 내부 MySQL 덤프 자동화

---

## 9. 결론

DB\_backup은 **파일 + DB 동시 백업**이라는 단순하지만 강력한 구조를 제공합니다.
운영 환경에서는 여기에 **보관 정책, 암호화, 원격 백업**을 더해 **신뢰할 수 있는 백업 체계**를 완성할 수 있습니다.

👉 문석님, 여기서 제가 `backup.sh`를 최종적으로 정리하면서 **“7일 이상 된 백업 자동 삭제” 기능까지 통합**해드릴까요?
